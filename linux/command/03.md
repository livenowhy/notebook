# OpenSSL生成根证书CA及签发证书

## 准备工作

### OpenSSL的配置
    
    openssl 配置文件 /etc/pki/tls/openssl.cnf
    检查或者配置如下:
    ####################################################################
    [ ca ]
    default_ca      = CA_default            # The default ca section
    
    ####################################################################
    [ CA_default ]
    
    dir             = /etc/pki/CA           # Where everything is kept
    certs           = $dir/certs            # Where the issued certs are kept
    crl_dir         = $dir/crl              # Where the issued crl are kept
    database        = $dir/index.txt        # database index file.
    #unique_subject = no                    # Set to 'no' to allow creation of
                                            # several ctificates with same subject.
    new_certs_dir   = $dir/newcerts         # default place for new certs.
    
    certificate     = $dir/cacert.pem       # The CA certificate
    serial          = $dir/serial           # The current serial number
    crlnumber       = $dir/crlnumber        # the current crl number
                                            # must be commented out to leave a V1 CRL
    crl             = $dir/crl.pem          # The current CRL
    private_key     = $dir/private/cakey.pem# The private key
    RANDFILE        = $dir/private/.rand    # private random number file
    
    x509_extensions = usr_cert              # The extentions to add to the cert
    
    创建相关子目录/文件
    certs: 存放证书的地方, 证书在签名之后会放置到这个目录下 $ mkdir certs
    crl:   存放已经吊销的证书. $ mkdir crl
    index.txt: OpenSSL 已签发证书的文本数据库文件(此文件通常在初始化的时候是空的) $ touch index.txt
    newcerts: 存放 CA 生成的新证书 $ mkdir newcerts
    serial: 证书签发时使用的序列号参考文件,该文件的序列号是以 16 进制格式进行存放的, 该文件必须提供并且包含一个有效的序列号 
    $ openssl rand -hex 16 > serial   (使用随机数生成器来初始化证书序列号)
    private: 这个目录存放私钥, 一个给CA使用, 一个给 OCSP 响应程序使用 $ mkdir private
    
### 生成根证书
    
    1、生成序列号
    $ cd /etc/pki/CA
    $ openssl rand -hex 16 > serial
    
    2、生成根证书私钥
    $ cd /etc/pki/CA/private
    $ openssl genrsa -out cakey.pem 1024
    
    3、生成证书请求(ca.csr)
    $ cd /etc/pki/CA/private
    $ openssl req -new -key cakey.pem -out ca.csr -subj "/C=CN/ST=ZHEJIANG/L=HANGZHOU/O=TEST/OU=CLOUD/CN=TEST"
    
    req: 执行证书签发命令
    new: 新证书签发请求
    key: 指定私钥路径
    out: 输出的csr文件的路径
    subj: 证书相关的用户信息(subject的缩写)
    
    4、检查证书请求信息
    $ openssl req -text -in ca.csr -noout


    5、自签发根证书
    $ cd /etc/pki/CA/private
    $ openssl x509 -req -days 365 -sha1 -extensions v3_ca -signkey cakey.pem -in ca.csr -out ca.cer
    $ cp ca.cer ../certs/.
        
    x509: 生成 x509 格式证书
    req: 输入csr文件
    days: 证书的有效期（天）
    sha1: 证书摘要采用sha1算法
    extensions: 按照 openssl.cnf 文件中配置的 v3_ca 项添加扩展
    signkey: 签发证书的私钥
    in: 要输入的 csr 文件
    out: 输出的 cer 证书文件
    
    6、检查证书
    $ openssl x509 -text -in ca.cer -noout

##  创建二级证书
    
    1、使用根证书签发二级证书
    $ openssl ca -config /etc/pki/tls/openssl.cnf -in live_key.csr -out sub_ca.cer


4.1.

备注：

4.2.



